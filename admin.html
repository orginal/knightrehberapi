<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knight Rehber Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .login-box {
            max-width: 400px;
            margin: 100px auto;
            background: #2D3748;
            padding: 40px;
            border-radius: 10px;
        }
        h1 {
            text-align: center;
            color: #FFD66B;
            margin-bottom: 30px;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #1A202C;
            border: 1px solid #4A5568;
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #FFD66B;
            color: #1a1a2e;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #FFC83D;
        }
        .btn-danger {
            background: #DC3545;
            color: white;
            width: auto;
            padding: 8px 15px;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .alert-success {
            background: #10B981;
        }
        .alert-error {
            background: #EF4444;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: #2D3748;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #FFD66B;
        }
        .stat-label {
            color: #8E97A8;
            font-size: 14px;
            margin-top: 10px;
        }
        .update-item {
            background: #2D3748;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .update-title {
            font-size: 18px;
            font-weight: bold;
            color: #FFD66B;
            margin-bottom: 10px;
        }
        .update-content {
            color: #E2E8F0;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .update-meta {
            display: flex;
            justify-content: space-between;
            color: #8E97A8;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- GÄ°RÄ°Å EKRANI -->
    <div id="loginScreen" class="login-box">
        <h1>ğŸ° Knight Rehber</h1>
        <div id="loginAlert" class="alert"></div>
        <input type="text" id="username" name="username" placeholder="KullanÄ±cÄ± AdÄ±" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
        <input type="password" id="password" name="password" placeholder="Åifre" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly')">
        <button onclick="girisYap()">GiriÅŸ Yap</button>
    </div>

    <!-- ANA PANEL -->
    <div id="mainPanel" style="display: none;" class="container">
        <h1>ğŸ° Knight Rehber Admin Paneli</h1>
        <button class="btn-danger" onclick="cikisYap()" style="float: right;">Ã‡Ä±kÄ±ÅŸ</button>
        <div style="clear: both;"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">0</div>
                <div class="stat-label">Aktif KullanÄ±cÄ±</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sentNotifications">0</div>
                <div class="stat-label">Bildirim</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pushTokens">0</div>
                <div class="stat-label">Push Token</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">1.0.0</div>
                <div class="stat-label">Versiyon</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">Aktif</div>
                <div class="stat-label">Durum</div>
            </div>
        </div>

        <!-- SEKMELER -->
        <div style="display: flex; gap: 10px; margin: 30px 0 20px 0; border-bottom: 2px solid #2D3748;">
            <button id="tabBanner" class="tab-button active" onclick="switchTab('banner')" style="flex: 1; padding: 12px; background: #FFD66B; color: #1a1a2e; border: none; border-radius: 8px 8px 0 0; font-weight: bold; cursor: pointer;">ğŸ–¼ï¸ Banner'lar</button>
            <button id="tabPazarTaksi" class="tab-button" onclick="switchTab('pazarTaksi')" style="flex: 1; padding: 12px; background: #2D3748; color: #FFD66B; border: none; border-radius: 8px 8px 0 0; font-weight: bold; cursor: pointer;">ğŸš• Pazar-Taksi</button>
            <button id="tabNotification" class="tab-button" onclick="switchTab('notification')" style="flex: 1; padding: 12px; background: #2D3748; color: #FFD66B; border: none; border-radius: 8px 8px 0 0; font-weight: bold; cursor: pointer;">ğŸ“¢ Bildirimler</button>
            <button id="tabUpdate" class="tab-button" onclick="switchTab('update')" style="flex: 1; padding: 12px; background: #2D3748; color: #FFD66B; border: none; border-radius: 8px 8px 0 0; font-weight: bold; cursor: pointer;">ğŸ“ GÃ¼ncelleme NotlarÄ±</button>
        </div>

        <!-- REKLAM BANNER YÃ–NETÄ°MÄ° -->
        <div id="tabContentBanner" class="tab-content">
        <h2 style="color: #FFD66B; margin: 30px 0 20px 0;">ğŸ–¼ï¸ Reklam Banner YÃ¶netimi</h2>
        <p style="color: #8E97A8; margin-bottom: 20px; font-size: 14px;">
            Her pozisyon iÃ§in maksimum 10 banner ekleyebilirsiniz. Mobil uygulamada tÃ¼m aktif banner'lar sÄ±rayla alt alta gÃ¶sterilir.
        </p>
        
        <div id="bannerAlert" class="alert"></div>

        <select id="bannerPosition" style="margin-bottom: 10px;">
            <option value="">-- Banner Konumu SeÃ§in --</option>
            <option value="home">ğŸ  Anasayfa</option>
            <option value="merchant">ğŸ’° Merchant Sekmesi (Pazar)</option>
            <option value="goldbar">ğŸ’ Goldbar Sekmesi</option>
            <option value="karakter">ğŸ‘¤ Karakter Sekmesi (Basit Atak Hesapla)</option>
            <option value="skill">âš”ï¸ Skill Hesapla</option>
            <option value="chardiz">ğŸ“ Char Diz</option>
        </select>
        
        <input type="url" id="bannerImageUrl" placeholder="ğŸ“· Banner GÃ¶rsel URL'si (zorunlu - direkt gÃ¶rsel linki, Ã¶rn: https://i.imgur.com/xxxxx.jpg)">
        <div style="background: #2D3748; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #FFD66B;">
            <p style="color: #FFD66B; font-size: 14px; font-weight: bold; margin: 0 0 10px 0;">ğŸ“Œ %100 Ã‡alÄ±ÅŸmasÄ± Ä°Ã§in:</p>
            <p style="color: #8E97A8; font-size: 13px; margin: 5px 0;">
                âœ… <strong>En Ä°yi YÃ¶ntem (Imgur):</strong><br>
                1. https://imgur.com adresine gidin<br>
                2. GÃ¶rselinizi yÃ¼kleyin<br>
                3. GÃ¶rsele saÄŸ tÄ±klayÄ±p "Resmi yeni sekmede aÃ§" deyin<br>
                4. Yeni sekmedeki URL'yi kopyalayÄ±n (https://i.imgur.com/xxxxx.jpg formatÄ±nda olmalÄ±)
            </p>
            <p style="color: #FF6B6B; font-size: 13px; margin: 5px 0;">
                âŒ <strong>KullanmayÄ±n:</strong><br>
                â€¢ imgur.com/a/... (Album linki)<br>
                â€¢ imgur.com/xxxxx (Sayfa linki)<br>
                â€¢ ibb.co/xxxxx (ImageBB sayfa linki)
            </p>
        </div>
        <input type="url" id="bannerClickUrl" placeholder="ğŸ”— TÄ±klama Linki (isteÄŸe baÄŸlÄ±)">
        <input type="number" id="bannerOrder" placeholder="ğŸ“Œ SÄ±ra (1 = en Ã¼stte, boÅŸ = sona)" min="1" style="margin-top: 10px;">
        <button onclick="bannerKaydet()">ğŸ’¾ Banner Kaydet</button>

        <h3 style="color: #FFD66B; margin: 40px 0 20px 0;">Mevcut Banner'lar</h3>
        <div id="bannerList"></div>
        </div>

        <!-- PAZAR-TAKSÄ° BANNER YÃ–NETÄ°MÄ° -->
        <div id="tabContentPazarTaksi" class="tab-content" style="display: none;">
        <h2 style="color: #FFD66B; margin: 30px 0 20px 0;">ğŸš• Pazar-Taksi Banner YÃ¶netimi</h2>
        <p style="color: #8E97A8; margin-bottom: 20px; font-size: 14px;">
            Her pozisyon iÃ§in maksimum 20 banner ekleyebilirsiniz. Mobil uygulamada tÃ¼m aktif banner'lar sÄ±rayla alt alta gÃ¶sterilir.
        </p>
        
        <div id="pazarTaksiAlert" class="alert"></div>

        <select id="pazarTaksiPosition" style="margin-bottom: 10px;">
            <option value="">-- Banner Konumu SeÃ§in --</option>
            <optgroup label="ğŸŒ Zero">
                <option value="pazar-taksi-zero-pazarcilar">ğŸ›’ Zero - PazarcÄ±lar</option>
                <option value="pazar-taksi-zero-taksi">ğŸš• Zero - Taksi Hizmeti</option>
                <option value="pazar-taksi-zero-isillion">âš”ï¸ Zero - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-zero-arena-legend">ğŸ† Zero - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="ğŸ›ï¸ Agartha">
                <option value="pazar-taksi-agartha-pazarcilar">ğŸ›’ Agartha - PazarcÄ±lar</option>
                <option value="pazar-taksi-agartha-taksi">ğŸš• Agartha - Taksi Hizmeti</option>
                <option value="pazar-taksi-agartha-isillion">âš”ï¸ Agartha - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-agartha-arena-legend">ğŸ† Agartha - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="ğŸ“¦ Pandora">
                <option value="pazar-taksi-pandora-pazarcilar">ğŸ›’ Pandora - PazarcÄ±lar</option>
                <option value="pazar-taksi-pandora-taksi">ğŸš• Pandora - Taksi Hizmeti</option>
                <option value="pazar-taksi-pandora-isillion">âš”ï¸ Pandora - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-pandora-arena-legend">ğŸ† Pandora - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="ğŸ± Felis">
                <option value="pazar-taksi-felis-pazarcilar">ğŸ›’ Felis - PazarcÄ±lar</option>
                <option value="pazar-taksi-felis-taksi">ğŸš• Felis - Taksi Hizmeti</option>
                <option value="pazar-taksi-felis-isillion">âš”ï¸ Felis - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-felis-arena-legend">ğŸ† Felis - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="ğŸŒ¿ Dryads">
                <option value="pazar-taksi-dryads-pazarcilar">ğŸ›’ Dryads - PazarcÄ±lar</option>
                <option value="pazar-taksi-dryads-taksi">ğŸš• Dryads - Taksi Hizmeti</option>
                <option value="pazar-taksi-dryads-isillion">âš”ï¸ Dryads - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-dryads-arena-legend">ğŸ† Dryads - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="âš”ï¸ Destan">
                <option value="pazar-taksi-destan-pazarcilar">ğŸ›’ Destan - PazarcÄ±lar</option>
                <option value="pazar-taksi-destan-taksi">ğŸš• Destan - Taksi Hizmeti</option>
                <option value="pazar-taksi-destan-isillion">âš”ï¸ Destan - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-destan-arena-legend">ğŸ† Destan - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="ğŸ° Minark">
                <option value="pazar-taksi-minark-pazarcilar">ğŸ›’ Minark - PazarcÄ±lar</option>
                <option value="pazar-taksi-minark-taksi">ğŸš• Minark - Taksi Hizmeti</option>
                <option value="pazar-taksi-minark-isillion">âš”ï¸ Minark - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-minark-arena-legend">ğŸ† Minark - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="â›°ï¸ Oreads">
                <option value="pazar-taksi-oreads-pazarcilar">ğŸ›’ Oreads - PazarcÄ±lar</option>
                <option value="pazar-taksi-oreads-taksi">ğŸš• Oreads - Taksi Hizmeti</option>
                <option value="pazar-taksi-oreads-isillion">âš”ï¸ Oreads - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-oreads-arena-legend">ğŸ† Oreads - Arena Legend (9str)</option>
            </optgroup>
            <optgroup label="ğŸ® Zion(steamko)">
                <option value="pazar-taksi-zion-pazarcilar">ğŸ›’ Zion(steamko) - PazarcÄ±lar</option>
                <option value="pazar-taksi-zion-taksi">ğŸš• Zion(steamko) - Taksi Hizmeti</option>
                <option value="pazar-taksi-zion-isillion">âš”ï¸ Zion(steamko) - Isillion - Felankor Kesimi</option>
                <option value="pazar-taksi-zion-arena-legend">ğŸ† Zion(steamko) - Arena Legend (9str)</option>
            </optgroup>
        </select>
        
        <input type="url" id="pazarTaksiImageUrl" placeholder="ğŸ“· Banner GÃ¶rsel URL'si (zorunlu - direkt gÃ¶rsel linki, Ã¶rn: https://i.imgur.com/xxxxx.jpg)">
        <div style="background: #2D3748; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #FFD66B;">
            <p style="color: #FFD66B; font-size: 14px; font-weight: bold; margin: 0 0 10px 0;">ğŸ“Œ %100 Ã‡alÄ±ÅŸmasÄ± Ä°Ã§in:</p>
            <p style="color: #8E97A8; font-size: 13px; margin: 5px 0;">
                âœ… <strong>En Ä°yi YÃ¶ntem (Imgur):</strong><br>
                1. https://imgur.com adresine gidin<br>
                2. GÃ¶rselinizi yÃ¼kleyin<br>
                3. GÃ¶rsele saÄŸ tÄ±klayÄ±p "Resmi yeni sekmede aÃ§" deyin<br>
                4. Yeni sekmedeki URL'yi kopyalayÄ±n (https://i.imgur.com/xxxxx.jpg formatÄ±nda olmalÄ±)
            </p>
            <p style="color: #FF6B6B; font-size: 13px; margin: 5px 0;">
                âŒ <strong>KullanmayÄ±n:</strong><br>
                â€¢ imgur.com/a/... (Album linki)<br>
                â€¢ imgur.com/xxxxx (Sayfa linki)<br>
                â€¢ ibb.co/xxxxx (ImageBB sayfa linki)
            </p>
        </div>
        <input type="url" id="pazarTaksiClickUrl" placeholder="ğŸ”— TÄ±klama Linki (isteÄŸe baÄŸlÄ±)">
        <input type="number" id="pazarTaksiOrder" placeholder="ğŸ“Œ SÄ±ra (1 = en Ã¼stte, boÅŸ = sona)" min="1" style="margin-top: 10px;">
        <button onclick="pazarTaksiBannerKaydet()">ğŸ’¾ Banner Kaydet</button>

        <h3 style="color: #FFD66B; margin: 40px 0 20px 0;">Mevcut Pazar-Taksi Banner'larÄ±</h3>
        <div id="pazarTaksiBannerList"></div>
        </div>

        <!-- BÄ°LDÄ°RÄ°M GÃ–NDERME -->
        <div id="tabContentNotification" class="tab-content" style="display: none;">
        <h2 style="color: #FFD66B; margin: 30px 0 20px 0;">ğŸ“¢ Bildirim GÃ¶nder</h2>
        
        <div id="notificationAlert" class="alert"></div>

        <input type="text" id="notificationTitle" placeholder="Bildirim BaÅŸlÄ±ÄŸÄ±">
        <textarea id="notificationMessage" placeholder="Bildirim MesajÄ±"></textarea>
        <input type="url" id="notificationImageUrl" placeholder="ğŸ“· Resim URL'si (isteÄŸe baÄŸlÄ±)">
        <select id="notificationTarget">
            <option value="all">ğŸ‘¥ TÃ¼m KullanÄ±cÄ±lar</option>
            <option value="premium">â­ Premium KullanÄ±cÄ±lar</option>
            <option value="free">ğŸ¯ Ãœcretsiz KullanÄ±cÄ±lar</option>
        </select>
        <button onclick="bildirimGonder()">ğŸ“¨ Bildirim GÃ¶nder</button>
        <p style="margin-top: 10px; font-size: 12px; color: #94a3b8;">Bildirim tÃ¼m kayÄ±tlÄ± cihazlara gider (kartkedi + ceylan26 ayrÄ± ayrÄ±).</p>

        <h3 style="color: #FFD66B; margin: 40px 0 20px 0;">Son GÃ¶nderilen Bildirimler</h3>
        <div id="notificationList"></div>
        </div>

        <!-- GÃœNCELLEME NOTLARI -->
        <div id="tabContentUpdate" class="tab-content" style="display: none;">
        <h2 style="color: #FFD66B; margin: 30px 0 20px 0;">ğŸ“ GÃ¼ncelleme NotlarÄ±</h2>
        
        <div id="updateAlert" class="alert"></div>

        <input type="text" id="updateTitle" placeholder="BaÅŸlÄ±k">
        <textarea id="updateContent" placeholder="Ä°Ã§erik"></textarea>
        <input type="url" id="updateImageUrl" placeholder="ğŸ“· Resim URL'si (isteÄŸe baÄŸlÄ±)">
        <select id="updateImportance">
            <option value="normal">Normal</option>
            <option value="yuksek">YÃ¼ksek Ã–nem</option>
        </select>
        <button onclick="guncellemeEkle()">â• GÃ¼ncelleme Ekle</button>

        <h3 style="color: #FFD66B; margin: 40px 0 20px 0;">Mevcut GÃ¼ncellemeler</h3>
        <div id="updateList"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let token = '';

        // GiriÅŸ yap
        async function girisYap() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(API_URL + '/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (data.success) {
                    token = data.token;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainPanel').style.display = 'block';
                    yukle();
                } else {
                    gosterAlert('loginAlert', data.error || 'Hata!', 'error');
                }
            } catch (err) {
                gosterAlert('loginAlert', 'BaÄŸlantÄ± hatasÄ±: ' + err.message, 'error');
            }
        }

        // Ã‡Ä±kÄ±ÅŸ yap
        function cikisYap() {
            token = '';
            document.getElementById('mainPanel').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
        }

        // Verileri yÃ¼kle
        async function yukle() {
            guncellemeleriYukle();
            istatistikleriYukle();
            bildirimleriYukle();
            bannerlariYukle();
        }

        // Ä°statistikleri yÃ¼kle
        async function istatistikleriYukle() {
            try {
                const res = await fetch(API_URL + '/admin/stats');
                const data = await res.json();
                document.getElementById('activeUsers').textContent = data.activeUsers || 0;
                document.getElementById('sentNotifications').textContent = data.sentNotifications || 0;
                document.getElementById('pushTokens').textContent = data.usersWithPushToken || 0;
            } catch (err) {
                console.error('Ä°statistik hatasÄ±:', err);
            }
        }

        // GÃ¼ncellemeleri yÃ¼kle
        async function guncellemeleriYukle() {
            try {
                const res = await fetch(API_URL + '/admin/updates', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                const guncellemeler = await res.json();
                const list = document.getElementById('updateList');

                if (guncellemeler.length === 0) {
                    list.innerHTML = '<p style="color: #8E97A8; text-align: center; padding: 20px;">HenÃ¼z gÃ¼ncelleme yok</p>';
                    return;
                }

                list.innerHTML = guncellemeler.map(g => `
                    <div class="update-item">
                        <div class="update-title">${g.importance === 'yuksek' ? 'â— ' : 'ğŸ“¢ '}${escapeHtml(g.title)}</div>
                        ${g.imageUrl ? `<img src="${escapeHtml(g.imageUrl)}" alt="GÃ¼ncelleme resmi" style="max-width: 100%; margin: 10px 0; border-radius: 8px;" onerror="this.style.display='none'">` : ''}
                        <div class="update-content">${escapeHtml(g.content)}</div>
                        <div class="update-meta">
                            <span>${g.importance === 'yuksek' ? 'YÃ¼ksek Ã–nem' : 'Normal'}</span>
                            <span>${g.date || ''}</span>
                            <button class="btn-danger" onclick="guncellemeSil(${g.id})">ğŸ—‘ï¸ Sil</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('YÃ¼kleme hatasÄ±:', err);
                document.getElementById('updateList').innerHTML = '<p style="color: #EF4444;">YÃ¼kleme hatasÄ±!</p>';
            }
        }

        // GÃ¼ncelleme ekle
        async function guncellemeEkle() {
            const title = document.getElementById('updateTitle').value;
            const content = document.getElementById('updateContent').value;
            const imageUrl = document.getElementById('updateImageUrl').value.trim();
            const importance = document.getElementById('updateImportance').value;

            if (!title || !content) {
                gosterAlert('updateAlert', 'BaÅŸlÄ±k ve iÃ§erik gerekli!', 'error');
                return;
            }

            try {
                const res = await fetch(API_URL + '/admin/add-update', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content, importance, imageUrl: imageUrl || null })
                });
                if (!res.ok) throw new Error('Ekleme baÅŸarÄ±sÄ±z: ' + res.status);

                const data = await res.json();

                if (data.success) {
                    gosterAlert('updateAlert', 'âœ… ' + data.message, 'success');
                    document.getElementById('updateTitle').value = '';
                    document.getElementById('updateContent').value = '';
                    document.getElementById('updateImageUrl').value = '';
                    guncellemeleriYukle();
                } else {
                    gosterAlert('updateAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('updateAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // GÃ¼ncelleme sil
        async function guncellemeSil(id) {
            if (!confirm('Silmek istediÄŸinize emin misiniz?')) return;

            try {
                const res = await fetch(API_URL + '/admin/delete-update/' + id, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Silme baÅŸarÄ±sÄ±z: ' + res.status);

                const data = await res.json();

                if (data.success) {
                    gosterAlert('updateAlert', 'âœ… Silindi!', 'success');
                    guncellemeleriYukle();
                } else {
                    gosterAlert('updateAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('updateAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Bildirim gÃ¶nder
        async function bildirimGonder() {
            const title = document.getElementById('notificationTitle').value;
            const message = document.getElementById('notificationMessage').value;
            const imageUrl = document.getElementById('notificationImageUrl').value.trim();
            const target = document.getElementById('notificationTarget').value;

            if (!title || !message) {
                gosterAlert('notificationAlert', 'BaÅŸlÄ±k ve mesaj gerekli!', 'error');
                return;
            }

            try {
                const res = await fetch(API_URL + '/admin/send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, message, target, imageUrl: imageUrl || null })
                });

                const data = await res.json();

                if (data.success) {
                    gosterAlert('notificationAlert', 'âœ… ' + data.message, 'success');
                    document.getElementById('notificationTitle').value = '';
                    document.getElementById('notificationMessage').value = '';
                    document.getElementById('notificationImageUrl').value = '';
                    bildirimleriYukle();
                    istatistikleriYukle();
                } else {
                    gosterAlert('notificationAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('notificationAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Bildirimleri yÃ¼kle
        async function bildirimleriYukle() {
            try {
                const res = await fetch(API_URL + '/admin/notifications');
                const bildirimler = await res.json();
                const list = document.getElementById('notificationList');

                if (bildirimler.length === 0) {
                    list.innerHTML = '<p style="color: #8E97A8; text-align: center; padding: 20px;">HenÃ¼z bildirim gÃ¶nderilmedi</p>';
                    return;
                }

                list.innerHTML = bildirimler.map(b => `
                    <div class="update-item">
                        <div class="update-title">ğŸ“¢ ${escapeHtml(b.title)}</div>
                        ${b.imageUrl ? `<img src="${escapeHtml(b.imageUrl)}" alt="Bildirim resmi" style="max-width: 100%; margin: 10px 0; border-radius: 8px;" onerror="this.style.display='none'">` : ''}
                        <div class="update-content">${escapeHtml(b.message)}</div>
                        <div class="update-meta">
                            <span>Hedef: ${b.target === 'all' ? 'TÃ¼m KullanÄ±cÄ±lar' : b.target === 'premium' ? 'Premium' : 'Ãœcretsiz'}</span>
                            <span>${new Date(b.created_at).toLocaleDateString('tr-TR')}</span>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Bildirim yÃ¼kleme hatasÄ±:', err);
            }
        }

        // Banner kaydet
        async function bannerKaydet() {
            const position = document.getElementById('bannerPosition').value;
            const imageUrl = document.getElementById('bannerImageUrl').value.trim();
            const clickUrl = document.getElementById('bannerClickUrl').value.trim();

            if (!position) {
                gosterAlert('bannerAlert', 'âš ï¸ LÃ¼tfen banner konumu seÃ§in!', 'error');
                return;
            }

            if (!imageUrl) {
                gosterAlert('bannerAlert', 'âš ï¸ Banner gÃ¶rsel URL\'si gerekli!', 'error');
                return;
            }

            try {
                const orderVal = document.getElementById('bannerOrder').value.trim();
                const order = orderVal ? parseInt(orderVal, 10) : undefined;
                const res = await fetch(API_URL + '/admin/banner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position, imageUrl, clickUrl, active: true, order })
                });

                const data = await res.json();

                if (data.success) {
                    gosterAlert('bannerAlert', 'âœ… Banner kaydedildi!', 'success');
                    document.getElementById('bannerImageUrl').value = '';
                    document.getElementById('bannerClickUrl').value = '';
                    document.getElementById('bannerOrder').value = '';
                    bannerlariYukle();
                } else {
                    gosterAlert('bannerAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('bannerAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Banner'larÄ± yÃ¼kle
        async function bannerlariYukle() {
            try {
                const res = await fetch(API_URL + '/admin/banners');
                if (!res.ok) {
                    throw new Error('Banner listesi yÃ¼klenemedi: ' + res.status);
                }
                const bannerlar = await res.json();
                const list = document.getElementById('bannerList');

                // Array kontrolÃ¼
                if (!Array.isArray(bannerlar)) {
                    console.error('Banner listesi bir array deÄŸil:', bannerlar);
                    list.innerHTML = '<p style="color: #EF4444; text-align: center; padding: 20px;">Banner listesi format hatasÄ±</p>';
                    return;
                }

                if (bannerlar.length === 0) {
                    list.innerHTML = '<p style="color: #8E97A8; text-align: center; padding: 20px;">HenÃ¼z banner eklenmedi</p>';
                    return;
                }

                const positionNames = {
                    'home': 'ğŸ  Anasayfa',
                    'merchant': 'ğŸ’° Merchant',
                    'goldbar': 'ğŸ’ Goldbar',
                    'karakter': 'ğŸ‘¤ Karakter',
                    'skill': 'âš”ï¸ Skill Hesapla',
                    'chardiz': 'ğŸ“ Char Diz'
                };

                // Pazar-Taksi olmayan banner'larÄ± filtrele
                const normalBanners = bannerlar.filter(b => !b.position || !b.position.startsWith('pazar-taksi-'));

                // Position'a gÃ¶re grupla
                const groupedBanners = {};
                normalBanners.forEach(b => {
                    if (!groupedBanners[b.position]) {
                        groupedBanners[b.position] = [];
                    }
                    groupedBanners[b.position].push(b);
                });

                list.innerHTML = Object.keys(groupedBanners).map(position => {
                    const banners = groupedBanners[position];
                    const maxBanners = 10;
                    return `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #FFD66B; margin-bottom: 15px;">${positionNames[position] || position} (${banners.length}/${maxBanners})</h4>
                            ${banners.map(b => `
                                <div class="update-item" style="margin-bottom: 15px;">
                                    <div class="update-title">Banner #${b.id} ${b.order != null ? `â€“ SÄ±ra: ${b.order}` : ''}</div>
                                    ${b.imageUrl ? `<img src="${escapeHtml(b.imageUrl)}" alt="Banner" style="max-width: 100%; margin: 10px 0; border-radius: 8px; max-height: 200px;" onerror="this.style.display='none'">` : ''}
                                    ${b.clickUrl ? `<div class="update-content">ğŸ”— Link: <a href="${escapeHtml(b.clickUrl)}" target="_blank" style="color: #FFD66B;">${escapeHtml(b.clickUrl)}</a></div>` : ''}
                                    <div class="update-meta">
                                        <span>Durum: ${b.active ? 'âœ… Aktif' : 'âŒ Pasif'}</span>
                                        <span>SÄ±ra: <input type="number" id="order-${b.id}" value="${b.order != null ? b.order : 999}" min="1" style="width: 60px; padding: 4px; background: #2D3748; color: #FFD66B; border: 1px solid #475467; border-radius: 4px;"></span>
                                        <button class="btn-danger" onclick="bannerSiraGuncelle(${b.id})">ğŸ“Œ SÄ±rayÄ± GÃ¼ncelle</button>
                                        <span>${b.createdAt ? new Date(b.createdAt).toLocaleDateString('tr-TR') : ''}</span>
                                        <button class="btn-danger" onclick="bannerSil(${b.id})">ğŸ—‘ï¸ Sil</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Banner yÃ¼kleme hatasÄ±:', err);
            }
        }

        // Banner sÄ±rasÄ± gÃ¼ncelle
        async function bannerSiraGuncelle(id) {
            const orderInput = document.getElementById('order-' + id);
            if (!orderInput) return;
            const order = parseInt(orderInput.value, 10);
            if (isNaN(order) || order < 1) {
                gosterAlert('bannerAlert', 'âš ï¸ GeÃ§erli bir sÄ±ra numarasÄ± girin (1 veya daha bÃ¼yÃ¼k)', 'error');
                return;
            }
            try {
                const res = await fetch(API_URL + '/admin/banner/' + id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order })
                });
                const data = await res.json();
                if (data.success) {
                    gosterAlert('bannerAlert', 'âœ… SÄ±ralama gÃ¼ncellendi!', 'success');
                    bannerlariYukle();
                    pazarTaksiBannerlariYukle();
                } else {
                    gosterAlert('bannerAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('bannerAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Banner sil
        async function bannerSil(id) {
            if (!confirm('Banner\'Ä± silmek istediÄŸinize emin misiniz?')) return;

            try {
                const res = await fetch(API_URL + '/admin/banner/' + id, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Silme baÅŸarÄ±sÄ±z: ' + res.status);

                const data = await res.json();

                if (data.success) {
                    gosterAlert('bannerAlert', 'âœ… Banner silindi!', 'success');
                    bannerlariYukle();
                } else {
                    gosterAlert('bannerAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('bannerAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Pazar-Taksi Banner kaydet
        async function pazarTaksiBannerKaydet() {
            const position = document.getElementById('pazarTaksiPosition').value;
            const imageUrl = document.getElementById('pazarTaksiImageUrl').value.trim();
            const clickUrl = document.getElementById('pazarTaksiClickUrl').value.trim();

            if (!position) {
                gosterAlert('pazarTaksiAlert', 'âš ï¸ LÃ¼tfen banner konumu seÃ§in!', 'error');
                return;
            }

            if (!imageUrl) {
                gosterAlert('pazarTaksiAlert', 'âš ï¸ Banner gÃ¶rsel URL\'si gerekli!', 'error');
                return;
            }

            try {
                const orderVal = document.getElementById('pazarTaksiOrder').value.trim();
                const order = orderVal ? parseInt(orderVal, 10) : undefined;
                const res = await fetch(API_URL + '/admin/banner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position, imageUrl, clickUrl, active: true, order })
                });

                const data = await res.json();

                if (data.success) {
                    gosterAlert('pazarTaksiAlert', 'âœ… Banner kaydedildi!', 'success');
                    document.getElementById('pazarTaksiImageUrl').value = '';
                    document.getElementById('pazarTaksiClickUrl').value = '';
                    document.getElementById('pazarTaksiOrder').value = '';
                    pazarTaksiBannerlariYukle();
                } else {
                    gosterAlert('pazarTaksiAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('pazarTaksiAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Pazar-Taksi Banner'larÄ± yÃ¼kle
        async function pazarTaksiBannerlariYukle() {
            try {
                const res = await fetch(API_URL + '/admin/banners');
                if (!res.ok) {
                    throw new Error('Banner listesi yÃ¼klenemedi: ' + res.status);
                }
                const bannerlar = await res.json();
                const list = document.getElementById('pazarTaksiBannerList');

                // Array kontrolÃ¼
                if (!Array.isArray(bannerlar)) {
                    console.error('Banner listesi bir array deÄŸil:', bannerlar);
                    list.innerHTML = '<p style="color: #EF4444; text-align: center; padding: 20px;">Banner listesi format hatasÄ±</p>';
                    return;
                }

                // Sadece Pazar-Taksi banner'larÄ±nÄ± filtrele
                const pazarTaksiBannerlar = bannerlar.filter(b => b.position && b.position.startsWith('pazar-taksi-'));

                if (pazarTaksiBannerlar.length === 0) {
                    list.innerHTML = '<p style="color: #8E97A8; text-align: center; padding: 20px;">HenÃ¼z Pazar-Taksi banner\'Ä± eklenmedi</p>';
                    return;
                }

                const positionNames = {
                    'pazar-taksi-zero-pazarcilar': 'ğŸ›’ Zero - PazarcÄ±lar',
                    'pazar-taksi-zero-taksi': 'ğŸš• Zero - Taksi Hizmeti',
                    'pazar-taksi-zero-isillion': 'âš”ï¸ Zero - Isillion - Felankor Kesimi',
                    'pazar-taksi-zero-arena-legend': 'ğŸ† Zero - Arena Legend (9str)',
                    'pazar-taksi-agartha-pazarcilar': 'ğŸ›’ Agartha - PazarcÄ±lar',
                    'pazar-taksi-agartha-taksi': 'ğŸš• Agartha - Taksi Hizmeti',
                    'pazar-taksi-agartha-isillion': 'âš”ï¸ Agartha - Isillion - Felankor Kesimi',
                    'pazar-taksi-agartha-arena-legend': 'ğŸ† Agartha - Arena Legend (9str)',
                    'pazar-taksi-pandora-pazarcilar': 'ğŸ›’ Pandora - PazarcÄ±lar',
                    'pazar-taksi-pandora-taksi': 'ğŸš• Pandora - Taksi Hizmeti',
                    'pazar-taksi-pandora-isillion': 'âš”ï¸ Pandora - Isillion - Felankor Kesimi',
                    'pazar-taksi-pandora-arena-legend': 'ğŸ† Pandora - Arena Legend (9str)',
                    'pazar-taksi-felis-pazarcilar': 'ğŸ›’ Felis - PazarcÄ±lar',
                    'pazar-taksi-felis-taksi': 'ğŸš• Felis - Taksi Hizmeti',
                    'pazar-taksi-felis-isillion': 'âš”ï¸ Felis - Isillion - Felankor Kesimi',
                    'pazar-taksi-felis-arena-legend': 'ğŸ† Felis - Arena Legend (9str)',
                    'pazar-taksi-dryads-pazarcilar': 'ğŸ›’ Dryads - PazarcÄ±lar',
                    'pazar-taksi-dryads-taksi': 'ğŸš• Dryads - Taksi Hizmeti',
                    'pazar-taksi-dryads-isillion': 'âš”ï¸ Dryads - Isillion - Felankor Kesimi',
                    'pazar-taksi-dryads-arena-legend': 'ğŸ† Dryads - Arena Legend (9str)',
                    'pazar-taksi-destan-pazarcilar': 'ğŸ›’ Destan - PazarcÄ±lar',
                    'pazar-taksi-destan-taksi': 'ğŸš• Destan - Taksi Hizmeti',
                    'pazar-taksi-destan-isillion': 'âš”ï¸ Destan - Isillion - Felankor Kesimi',
                    'pazar-taksi-destan-arena-legend': 'ğŸ† Destan - Arena Legend (9str)',
                    'pazar-taksi-minark-pazarcilar': 'ğŸ›’ Minark - PazarcÄ±lar',
                    'pazar-taksi-minark-taksi': 'ğŸš• Minark - Taksi Hizmeti',
                    'pazar-taksi-minark-isillion': 'âš”ï¸ Minark - Isillion - Felankor Kesimi',
                    'pazar-taksi-minark-arena-legend': 'ğŸ† Minark - Arena Legend (9str)',
                    'pazar-taksi-oreads-pazarcilar': 'ğŸ›’ Oreads - PazarcÄ±lar',
                    'pazar-taksi-oreads-taksi': 'ğŸš• Oreads - Taksi Hizmeti',
                    'pazar-taksi-oreads-isillion': 'âš”ï¸ Oreads - Isillion - Felankor Kesimi',
                    'pazar-taksi-oreads-arena-legend': 'ğŸ† Oreads - Arena Legend (9str)',
                    'pazar-taksi-zion-pazarcilar': 'ğŸ›’ Zion(steamko) - PazarcÄ±lar',
                    'pazar-taksi-zion-taksi': 'ğŸš• Zion(steamko) - Taksi Hizmeti',
                    'pazar-taksi-zion-isillion': 'âš”ï¸ Zion(steamko) - Isillion - Felankor Kesimi',
                    'pazar-taksi-zion-arena-legend': 'ğŸ† Zion(steamko) - Arena Legend (9str)'
                };

                // Position'a gÃ¶re grupla
                const groupedBanners = {};
                pazarTaksiBannerlar.forEach(b => {
                    if (!groupedBanners[b.position]) {
                        groupedBanners[b.position] = [];
                    }
                    groupedBanners[b.position].push(b);
                });

                list.innerHTML = Object.keys(groupedBanners).map(position => {
                    const banners = groupedBanners[position];
                    const maxBanners = 20;
                    return `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #FFD66B; margin-bottom: 15px;">${positionNames[position] || position} (${banners.length}/${maxBanners})</h4>
                            ${banners.map(b => `
                                <div class="update-item" style="margin-bottom: 15px;">
                                    <div class="update-title">Banner #${b.id} ${b.order != null ? `â€“ SÄ±ra: ${b.order}` : ''}</div>
                                    ${b.imageUrl ? `<img src="${escapeHtml(b.imageUrl)}" alt="Banner" style="max-width: 100%; margin: 10px 0; border-radius: 8px; max-height: 200px;" onerror="this.style.display='none'">` : ''}
                                    ${b.clickUrl ? `<div class="update-content">ğŸ”— Link: <a href="${escapeHtml(b.clickUrl)}" target="_blank" style="color: #FFD66B;">${escapeHtml(b.clickUrl)}</a></div>` : ''}
                                    <div class="update-meta">
                                        <span>Durum: ${b.active ? 'âœ… Aktif' : 'âŒ Pasif'}</span>
                                        <span>SÄ±ra: <input type="number" id="order-${b.id}" value="${b.order != null ? b.order : 999}" min="1" style="width: 60px; padding: 4px; background: #2D3748; color: #FFD66B; border: 1px solid #475467; border-radius: 4px;"></span>
                                        <button class="btn-danger" onclick="bannerSiraGuncelle(${b.id})">ğŸ“Œ SÄ±rayÄ± GÃ¼ncelle</button>
                                        <span>${b.createdAt ? new Date(b.createdAt).toLocaleDateString('tr-TR') : ''}</span>
                                        <button class="btn-danger" onclick="pazarTaksiBannerSil(${b.id})">ğŸ—‘ï¸ Sil</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Pazar-Taksi banner yÃ¼kleme hatasÄ±:', err);
            }
        }

        // Pazar-Taksi Banner sil
        async function pazarTaksiBannerSil(id) {
            if (!confirm('Banner\'Ä± silmek istediÄŸinize emin misiniz?')) return;

            try {
                const res = await fetch(API_URL + '/admin/banner/' + id, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Silme baÅŸarÄ±sÄ±z: ' + res.status);

                const data = await res.json();

                if (data.success) {
                    gosterAlert('pazarTaksiAlert', 'âœ… Banner silindi!', 'success');
                    pazarTaksiBannerlariYukle();
                } else {
                    gosterAlert('pazarTaksiAlert', 'âŒ ' + (data.error || 'Hata!'), 'error');
                }
            } catch (err) {
                gosterAlert('pazarTaksiAlert', 'âŒ Hata: ' + err.message, 'error');
            }
        }

        // Sekme deÄŸiÅŸtirme
        function switchTab(tabName) {
            // TÃ¼m sekmeleri gizle
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // TÃ¼m sekme butonlarÄ±nÄ± pasif yap
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.style.background = '#2D3748';
                btn.style.color = '#FFD66B';
            });
            
            // SeÃ§ili sekmeyi gÃ¶ster
            let contentId;
            if (tabName === 'pazarTaksi') {
                contentId = 'tabContentPazarTaksi';
            } else {
                contentId = 'tabContent' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            }
            const contentElement = document.getElementById(contentId);
            if (contentElement) {
                contentElement.style.display = 'block';
            }
            
            // SeÃ§ili sekme butonunu aktif yap
            let buttonId;
            if (tabName === 'pazarTaksi') {
                buttonId = 'tabPazarTaksi';
            } else {
                buttonId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            }
            const activeBtn = document.getElementById(buttonId);
            if (activeBtn) {
                activeBtn.style.background = '#FFD66B';
                activeBtn.style.color = '#1a1a2e';
            }

            // Pazar-Taksi sekmesine geÃ§ildiÄŸinde banner'larÄ± yÃ¼kle
            if (tabName === 'pazarTaksi') {
                pazarTaksiBannerlariYukle();
            }
        }

        // XSS korumasÄ±
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Alert gÃ¶ster
        function gosterAlert(id, mesaj, tip) {
            const alert = document.getElementById(id);
            alert.textContent = mesaj;
            alert.className = 'alert alert-' + tip;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
